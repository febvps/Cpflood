<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Security Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.6rem;
            color: #667eea;
        }

        h2 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: #a0a0ff;
            border-bottom: 1px solid #3a3a5a;
            padding-bottom: 6px;
        }

        .section {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #3a3a5a;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.85rem;
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 150px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            background: #0f0f23;
            color: #fff;
            font-size: 0.9rem;
        }

        input[type="number"] {
            width: 120px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }

        textarea.large {
            min-height: 120px;
        }

        .hint {
            font-size: 0.75rem;
            color: #666;
            margin-top: 3px;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 100px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            flex: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: #3a3a5a;
            color: #ccc;
        }

        .btn-cyan {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            color: white;
        }

        .btn-orange {
            background: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
            color: white;
        }

        .status-bar {
            margin-top: 12px;
            padding: 10px 12px;
            background: rgba(102, 126, 234, 0.15);
            border-radius: 6px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .status-bar strong {
            color: #38ef7d;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .tag {
            background: rgba(56, 239, 125, 0.2);
            border: 1px solid #38ef7d;
            color: #38ef7d;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .tag.connecting { background: rgba(255, 193, 7, 0.2); border-color: #ffc107; color: #ffc107; }
        .tag.failed { background: rgba(235, 51, 73, 0.2); border-color: #eb3349; color: #eb3349; }
        .tag.banned { background: rgba(139, 0, 0, 0.3); border-color: #8b0000; color: #ff6b6b; }
        .tag.in-room { background: rgba(56, 239, 125, 0.3); }

        .log-box {
            height: 200px;
            overflow-y: auto;
            background: #0a0a15;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.75rem;
            border: 1px solid #3a3a5a;
        }

        .log-box p {
            margin-bottom: 3px;
            padding: 3px 6px;
            border-radius: 3px;
            word-break: break-all;
        }

        .log-box .success { background: rgba(56, 239, 125, 0.1); color: #38ef7d; }
        .log-box .error { background: rgba(235, 51, 73, 0.1); color: #eb3349; }
        .log-box .info { background: rgba(102, 126, 234, 0.1); color: #a0a0ff; }
        .log-box .warning { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .log-box .ban { background: rgba(139, 0, 0, 0.2); color: #ff6b6b; }
        .log-box .dm { background: rgba(0, 210, 255, 0.1); color: #00d2ff; }
        .log-box .raw { background: rgba(100, 100, 100, 0.15); color: #888; font-size: 0.7rem; }
        .log-box .server { background: rgba(255, 165, 0, 0.1); color: #ffa500; }

        .chat-box {
            height: 180px;
            overflow-y: auto;
            background: #0a0a15;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #3a3a5a;
        }

        .chat-msg {
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
        }

        .chat-msg.own { background: rgba(56, 239, 125, 0.1); border-left-color: #38ef7d; }
        .chat-msg.dm { background: rgba(0, 210, 255, 0.1); border-left-color: #00d2ff; }

        .chat-msg .from { font-weight: 600; color: #667eea; font-size: 0.8rem; }
        .chat-msg.own .from { color: #38ef7d; }
        .chat-msg.dm .from { color: #00d2ff; }
        .chat-msg .text { margin-top: 4px; word-wrap: break-word; font-size: 0.9rem; }
        .chat-msg .time { font-size: 0.65rem; color: #555; text-align: right; margin-top: 3px; }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }

        .tab {
            padding: 8px 16px;
            background: #3a3a5a;
            border: none;
            border-radius: 6px 6px 0 0;
            color: #888;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .tab.active {
            background: rgba(102, 126, 234, 0.3);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .user-list {
            max-height: 120px;
            overflow-y: auto;
            background: #0a0a15;
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            padding: 8px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .security-notice {
            background: rgba(255, 165, 0, 0.15);
            border: 1px solid #ffa500;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: #ffa500;
        }

        .hidden { display: none !important; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: #3a3a5a; border-radius: 3px; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sending { animation: pulse 1s infinite; }

        .indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .indicator.on { background: #38ef7d; }
        .indicator.off { background: #eb3349; }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Chat Security Tester</h1>

        <div class="security-notice">
            ‚ö†Ô∏è <strong>Security Testing Tool</strong> - This tool tests server-side validation of roles, room access, and device IDs. 
            Use only on systems you have permission to test.
        </div>

        <!-- Settings -->
        <div class="section">
            <h2>‚öôÔ∏è Settings & Connection</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Server URL:</label>
                    <input type="text" id="serverUrl" value="wss://chatp.net:5333/server">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="chkDebugMode" checked> Debug Mode (Show Raw Messages)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="chkAutoDevice" checked> Auto-change Device on Ban
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button id="btnBackground" class="btn btn-success btn-small">üîã Background Mode</button>
                <button id="btnCheckIP" class="btn btn-secondary btn-small">Check IP</button>
            </div>

            <div id="bgStatus" class="status-bar hidden">
                <span><span class="indicator on"></span> Background Active</span>
                <span id="lastPing">--</span>
            </div>
        </div>

        <!-- Connect IDs -->
        <div class="section">
            <h2>1. Connect IDs</h2>
            
            <div class="form-group">
                <label>IDs (# separated):</label>
                <textarea id="inputIds" placeholder="id1#id2#id3" rows="2"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="inputPassword">
                </div>
                <div class="form-group">
                    <label>Connect Delay (ms):</label>
                    <input type="number" id="connectDelay" value="2000">
                </div>
            </div>

            <div class="button-group">
                <button id="btnConnect" class="btn btn-primary">Connect</button>
                <button id="btnDisconnect" class="btn btn-danger" disabled>Disconnect All</button>
            </div>

            <div class="status-bar">
                <span><span class="indicator off" id="connIndicator"></span> Connected: <strong id="connCount">0</strong></span>
                <span>In Room: <strong id="inRoomCount">0</strong></span>
            </div>
            
            <div class="tag-list" id="idTags"></div>
        </div>

        <!-- Tabs -->
        <div class="section">
            <div class="tabs">
                <button class="tab active" data-tab="roomTab">üì¢ Room</button>
                <button class="tab" data-tab="dmTab">üí¨ DM</button>
                <button class="tab" data-tab="testTab">üî¨ Security Tests</button>
            </div>

            <!-- Room Tab -->
            <div id="roomTab" class="tab-content active">
                <h2>2. Room Management</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Room/Conference Name:</label>
                        <input type="text" id="inputRoom" placeholder="room name or conference">
                    </div>
                    <div class="form-group">
                        <label>Join Delay (ms):</label>
                        <input type="number" id="joinDelay" value="5000">
                    </div>
                </div>

                <!-- Role Testing -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Role to Claim (Test Server Validation):</label>
                        <select id="claimRole">
                            <option value="">Default (none)</option>
                            <option value="member">member</option>
                            <option value="moderator">moderator</option>
                            <option value="admin">admin</option>
                            <option value="owner">owner</option>
                            <option value="super">super</option>
                        </select>
                        <div class="hint">Tests if server validates role claims</div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="btnFetchRooms" class="btn btn-secondary" disabled>Fetch Rooms</button>
                    <button id="btnJoinRoom" class="btn btn-primary" disabled>Join Room</button>
                    <button id="btnStopJoin" class="btn btn-orange hidden">Stop</button>
                    <button id="btnLeaveRoom" class="btn btn-warning" disabled>Leave</button>
                </div>

                <div class="form-group" style="margin-top: 10px;">
                    <label>Available Rooms:</label>
                    <select id="roomList" size="3">
                        <option disabled>-- Click Fetch Rooms --</option>
                    </select>
                </div>

                <div id="roomStatus" class="status-bar hidden">
                    <span>Room: <strong id="currentRoom"></strong></span>
                    <span>IDs in Room: <strong id="roomIdCount">0</strong></span>
                </div>

                <div id="joinProgress" class="log-box hidden" style="height: 100px; margin-top: 10px;"></div>

                <!-- Room Messages -->
                <div class="form-group" style="margin-top: 15px;">
                    <label>Messages (one per line):</label>
                    <textarea id="roomMsgs" class="large" placeholder="Message 1&#10;Message 2"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Interval (ms):</label>
                        <input type="number" id="msgInterval" value="3000">
                    </div>
                </div>

                <div class="button-group">
                    <button id="btnStartMsgs" class="btn btn-success" disabled>Start Sending</button>
                    <button id="btnStopMsgs" class="btn btn-danger" disabled>Stop</button>
                </div>

                <div id="msgStatus" class="status-bar hidden">
                    <span id="msgLoopStatus">Sending...</span>
                    <span>Sent: <strong id="msgSentCount">0</strong></span>
                </div>
            </div>

            <!-- DM Tab -->
            <div id="dmTab" class="tab-content">
                <h2>2. Direct Messages</h2>
                
                <div class="form-group">
                    <label>Target Users (one per line or # separated):</label>
                    <textarea id="dmTargets" placeholder="user1&#10;user2&#10;user3" rows="3"></textarea>
                </div>

                <div class="button-group">
                    <button id="btnFetchUsers" class="btn btn-secondary btn-small" disabled>Fetch from Room</button>
                    <button id="btnClearTargets" class="btn btn-secondary btn-small">Clear</button>
                </div>

                <div class="form-group" style="margin-top: 10px;">
                    <label>Users (<span id="targetCount">0</span>):</label>
                    <div class="user-list" id="targetList">
                        <p style="color: #555; text-align: center; font-size: 0.8rem;">No users</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Message:</label>
                    <textarea id="dmMessage" class="large" placeholder="Your message..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Delay (ms):</label>
                        <input type="number" id="dmDelay" value="2000">
                    </div>
                </div>

                <div class="button-group">
                    <button id="btnSendDM" class="btn btn-cyan" disabled>üì® Send to All</button>
                    <button id="btnStopDM" class="btn btn-danger hidden">Stop</button>
                </div>

                <div id="dmStatus" class="status-bar hidden">
                    <span id="dmLoopStatus">Sending...</span>
                    <span>Sent: <strong id="dmSentCount">0</strong></span>
                </div>
            </div>

            <!-- Security Tests Tab -->
            <div id="testTab" class="tab-content">
                <h2>üî¨ Security Tests</h2>

                <div class="form-group">
                    <label>Send Custom Raw Payload (JSON):</label>
                    <textarea id="customPayload" class="large" placeholder='{"handler": "room_join", "name": "test", "role": "admin"}'></textarea>
                    <div class="hint">Send any JSON payload to test server responses</div>
                </div>

                <div class="button-group">
                    <button id="btnSendRaw" class="btn btn-warning" disabled>Send Raw Payload</button>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label>Quick Tests:</label>
                </div>

                <div class="button-group">
                    <button id="btnTestRooms" class="btn btn-secondary btn-small" disabled>Test All Room Handlers</button>
                    <button id="btnTestRoles" class="btn btn-secondary btn-small" disabled>Test Role Claims</button>
                    <button id="btnTestJoin" class="btn btn-secondary btn-small" disabled>Test Join Variations</button>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label>Handler Variations to Test:</label>
                    <div class="hint">
                        Room List: room_list, rooms, conference_list, conferences, group_list, groups, get_rooms, list_rooms, public_rooms<br>
                        Join: room_join, join_room, conference_join, join_conference, group_join, enter_room
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div class="section">
            <h2>3. Messages</h2>
            <div class="chat-box" id="chatBox">
                <p style="color: #555; text-align: center; font-size: 0.8rem;">Messages appear here...</p>
            </div>
        </div>

        <!-- Log -->
        <div class="section">
            <h2>üìã Debug Log</h2>
            <div class="log-box" id="logBox" style="height: 250px;">
                <p class="info">Ready...</p>
            </div>
            <div class="button-group">
                <button id="btnClearLog" class="btn btn-secondary btn-small">Clear</button>
                <button id="btnExportLog" class="btn btn-secondary btn-small">Export</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DEVICE GENERATOR ====================
        const DeviceGen = {
            brands: ['Samsung','Google','OnePlus','Xiaomi','Huawei','Oppo','Vivo','Realme','Motorola','Nokia','Sony','LG','Asus','Honor','Poco','Nothing','Tecno','Infinix','Redmi','HTC','ZTE','Meizu','Lenovo','Sharp','TCL','Alcatel','BLU','Cubot','Umidigi','Doogee','Oukitel','Ulefone','Blackview','Fairphone','Razer','ROG','RedMagic','iQOO','Nubia','Essential','CAT','Wiko'],
            
            models: {
                'Samsung': ['Galaxy S21','Galaxy S22','Galaxy S23','Galaxy S24','Galaxy A52','Galaxy A53','Galaxy A54','Galaxy Note20','Galaxy Z Flip4','Galaxy Z Fold5'],
                'Google': ['Pixel 4','Pixel 5','Pixel 6','Pixel 7','Pixel 8','Pixel 6a','Pixel 7a'],
                'OnePlus': ['9 Pro','10 Pro','11','Nord 2','Nord CE 3','8T'],
                'Xiaomi': ['Mi 11','Mi 12','Mi 13','Redmi Note 11','Redmi Note 12','Poco F4'],
                'default': ['Model X','Pro Max','Ultra','Lite','Plus','5G']
            },
            
            sdks: [28,29,30,31,32,33,34],
            
            gen() {
                const brand = this.brands[Math.floor(Math.random() * this.brands.length)];
                const models = this.models[brand] || this.models['default'];
                const model = models[Math.floor(Math.random() * models.length)];
                const sdk = this.sdks[Math.floor(Math.random() * this.sdks.length)];
                const build = Math.floor(Math.random() * 900) + 100;
                
                return {
                    brand, model, sdk, build,
                    id: `${build}-${brand}-${model.replace(/\s/g,'_')}-${sdk}`,
                    android: this.hex(16),
                    imei: this.num(15)
                };
            },
            
            hex(n) { let s=''; for(let i=0;i<n;i++) s+='0123456789abcdef'[Math.floor(Math.random()*16)]; return s; },
            num(n) { let s=''; for(let i=0;i<n;i++) s+=Math.floor(Math.random()*10); return s; }
        };

        // ==================== BACKGROUND KEEP ALIVE ====================
        class KeepAlive {
            constructor() { this.active = false; this.interval = null; }
            
            start(cb) {
                if (this.active) return true;
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.frequency.value = 1;
                    gain.gain.value = 0.001;
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    this.interval = setInterval(cb, 10000);
                    this.active = true;
                    return true;
                } catch(e) { return false; }
            }
        }

        // ==================== CLIENT ====================
        class Client {
            constructor(user, pass, url, callbacks, device) {
                this.url = url;
                this.user = user;
                this.pass = pass;
                this.device = device || DeviceGen.gen();
                this.ws = null;
                this.connected = false;
                this.inRoom = false;
                this.joinConfirmed = false;
                this.banned = false;
                this.banReason = '';
                this.currentRoom = '';
                this.targetRoom = '';
                this.roomUsers = [];
                this.pingInt = null;
                this.manualDC = false;
                this.cb = callbacks;
                
                this.connect();
            }
            
            connect() {
                try {
                    if (this.ws) try { this.ws.close(); } catch(e) {}
                    this.ws = new WebSocket(this.url);
                    this.ws.onopen = () => this._onOpen();
                    this.ws.onclose = () => this._onClose();
                    this.ws.onmessage = e => this._onMsg(e);
                    this.ws.onerror = () => {};
                } catch(e) {
                    this.cb.log?.(`[${this.user}] Connect error`);
                }
            }
            
            disconnect() {
                this.manualDC = true;
                this.connected = false;
                this.inRoom = false;
                if (this.pingInt) clearInterval(this.pingInt);
                if (this.ws) try { this.ws.close(); } catch(e) {}
            }
            
            newDevice() {
                this.device = DeviceGen.gen();
                this.banned = false;
                return this.device;
            }
            
            _onOpen() {
                this.cb.log?.(`[${this.user}] Connected to server`);
                this._login();
            }
            
            _onClose() {
                this.connected = false;
                this.inRoom = false;
                if (this.pingInt) clearInterval(this.pingInt);
                this.cb.log?.(`[${this.user}] Disconnected`);
                this.cb.disconnect?.(this.manualDC);
            }
            
            _onMsg(e) {
                const raw = e.data;
                if (!raw) return;
                
                // Log all raw messages
                this.cb.raw?.(this.user, raw);
                
                try {
                    const d = JSON.parse(raw);
                    this._handle(d);
                } catch(err) {}
            }
            
            _handle(d) {
                const h = d.handler;
                const t = d.type;
                
                // Login
                if (h === 'login_event') {
                    if (t === 'success') {
                        this.connected = true;
                        this._startPing();
                        this.cb.log?.(`[${this.user}] ‚úì Logged in`);
                        this.cb.login?.();
                    } else {
                        this.cb.log?.(`[${this.user}] ‚úó Login failed: ${d.reason || t}`);
                        this.cb.loginFail?.(d.reason);
                    }
                }
                
                // Room list responses (try to catch all variations)
                if (h === 'room_list' || h === 'rooms' || h === 'conference_list' || h === 'conferences' || 
                    h === 'group_list' || h === 'groups' || h === 'public_rooms' || h === 'list_rooms' ||
                    d.rooms || d.conferences || d.groups) {
                    const rooms = d.rooms || d.conferences || d.groups || d.list || d.items || [];
                    this.cb.log?.(`[${this.user}] Got ${rooms.length} rooms/conferences`);
                    this.cb.rooms?.(rooms);
                }
                
                // Room/Conference events
                if (h === 'room_event' || h === 'conference_event' || h === 'group_event' || h === 'room' || h === 'conference') {
                    const room = d.room || d.name || d.conference || d.group;
                    
                    // Join success variations
                    if (t === 'join_success' || t === 'joined' || t === 'join' || t === 'enter' || 
                        t === 'entered' || t === 'room_joined' || t === 'conference_joined') {
                        this._joinSuccess(room || this.targetRoom);
                    }
                    
                    // Member list = we're in
                    if (t === 'members' || t === 'users' || t === 'member_list' || t === 'user_list' || d.members || d.users) {
                        if (this.targetRoom && !this.joinConfirmed) {
                            this._joinSuccess(this.targetRoom);
                        }
                        this.roomUsers = d.members || d.users || [];
                        this.cb.users?.(this.roomUsers);
                    }
                    
                    // Messages
                    if (t === 'text' || t === 'message' || t === 'msg') {
                        const msgRoom = d.room || d.conference || d.group;
                        if (msgRoom === this.targetRoom && !this.joinConfirmed) {
                            this._joinSuccess(msgRoom);
                        }
                        this.cb.message?.(d.from || d.sender, d.body || d.message || d.text, msgRoom, 'room');
                    }
                    
                    // Ban
                    if (t === 'banned' || t === 'ban' || t === 'blocked' || this._isBan(d)) {
                        this._handleBan(d);
                    }
                    
                    // Kick
                    if (t === 'kicked' || t === 'kick') {
                        this.inRoom = false;
                        this.joinConfirmed = false;
                        this.cb.log?.(`[${this.user}] üë¢ Kicked`);
                    }
                    
                    // User events
                    if (t === 'user_joined' || t === 'user_enter') {
                        this.cb.log?.(`[${this.user}] üë§ ${d.username || d.user} joined (role: ${d.role || 'unknown'})`);
                        if (!this.roomUsers.find(u => (u.username || u) === (d.username || d.user))) {
                            this.roomUsers.push({ username: d.username || d.user, role: d.role });
                        }
                    }
                    
                    // Error
                    if (t === 'error' || t === 'fail' || t === 'failed' || t === 'join_error') {
                        const reason = d.reason || d.message || d.error || 'Unknown';
                        this.cb.log?.(`[${this.user}] ‚ùå Error: ${reason}`);
                        if (this._isBan(d)) this._handleBan(d);
                    }
                }
                
                // Private messages
                if (h === 'private_message' || h === 'pm' || h === 'direct_message' || h === 'dm' || h === 'message') {
                    if (d.from && (d.body || d.message || d.text)) {
                        this.cb.message?.(d.from, d.body || d.message || d.text, null, 'dm');
                    }
                }
                
                // Admin events
                if (h === 'room_admin' || h === 'admin') {
                    this.cb.log?.(`[${this.user}] üõ°Ô∏è Admin: ${JSON.stringify(d)}`);
                    if ((t === 'ban' || t === 'banned') && (d.t_username === this.user || d.username === this.user)) {
                        this._handleBan(d);
                    }
                }
            }
            
            _joinSuccess(room) {
                if (this.joinConfirmed) return;
                this.currentRoom = room;
                this.inRoom = true;
                this.joinConfirmed = true;
                this.banned = false;
                this.cb.log?.(`[${this.user}] ‚úì IN ROOM: ${room}`);
                this.cb.joined?.(room);
            }
            
            _isBan(d) {
                const r = (d.reason || d.message || d.error || '').toLowerCase();
                return r.includes('ban') || r.includes('block') || r.includes('forbidden') || r.includes('not allowed');
            }
            
            _handleBan(d) {
                this.banned = true;
                this.inRoom = false;
                this.joinConfirmed = false;
                this.banReason = d.reason || d.message || 'Banned';
                this.cb.log?.(`[${this.user}] üö´ BANNED: ${this.banReason}`);
                this.cb.banned?.(d.by || d.admin, this.banReason);
            }
            
            _startPing() {
                if (this.pingInt) clearInterval(this.pingInt);
                this.pingInt = setInterval(() => {
                    if (this.ws?.readyState === WebSocket.OPEN) this.ws.send('');
                }, 15000);
            }
            
            _login() {
                this._send({ handler: 'login', id: this._id(), username: this.user, password: this.pass });
            }
            
            // Fetch rooms - try ALL possible handlers
            fetchRooms() {
                const handlers = [
                    'room_list', 'rooms', 'get_rooms', 'list_rooms', 'public_rooms',
                    'conference_list', 'conferences', 'get_conferences', 'list_conferences',
                    'group_list', 'groups', 'get_groups', 'list_groups',
                    'chat_rooms', 'available_rooms', 'room_directory'
                ];
                
                handlers.forEach((h, i) => {
                    setTimeout(() => {
                        this._send({ handler: h, id: this._id(), type: 'list' });
                        this.cb.log?.(`[${this.user}] Testing handler: ${h}`);
                    }, i * 200);
                });
            }
            
            // Join with optional role claim
            join(room, claimRole = '') {
                if (this.banned) return false;
                this.targetRoom = room;
                this.joinConfirmed = false;
                this.inRoom = false;
                
                // Build join payload
                const payload = {
                    handler: 'room_join',
                    id: this._id(),
                    name: room
                };
                
                // If role claim is specified, add it (tests server validation)
                if (claimRole) {
                    payload.role = claimRole;
                    payload.user_role = claimRole;
                    payload.member_role = claimRole;
                    this.cb.log?.(`[${this.user}] Claiming role: ${claimRole}`);
                }
                
                // Try multiple join handlers
                const joinHandlers = ['room_join', 'join_room', 'conference_join', 'join_conference', 'group_join', 'enter_room', 'join'];
                
                joinHandlers.forEach((h, i) => {
                    setTimeout(() => {
                        const p = { ...payload, handler: h };
                        this._send(p);
                    }, i * 100);
                });
                
                return true;
            }
            
            leave(room) {
                this.inRoom = false;
                this.joinConfirmed = false;
                this.currentRoom = '';
                this._send({ handler: 'room_leave', id: this._id(), name: room });
                this._send({ handler: 'leave_room', id: this._id(), name: room });
                this._send({ handler: 'conference_leave', id: this._id(), name: room });
            }
            
            fetchUsers() {
                const room = this.currentRoom || this.targetRoom;
                this._send({ handler: 'room_users', id: this._id(), room: room, name: room });
                this._send({ handler: 'get_members', id: this._id(), room: room, name: room });
                this._send({ handler: 'member_list', id: this._id(), room: room, name: room });
            }
            
            sendRoom(room, msg) {
                return this._send({
                    handler: 'room_message',
                    id: this._id(true),
                    room: room,
                    type: 'text',
                    body: msg
                });
            }
            
            sendDM(to, msg) {
                // Try multiple DM handlers
                this._send({ handler: 'private_message', id: this._id(true), to: to, type: 'text', body: msg });
                this._send({ handler: 'message', id: this._id(true), to: to, type: 'text', body: msg });
                this._send({ handler: 'dm', id: this._id(true), to: to, type: 'text', body: msg });
                this._send({ handler: 'direct_message', id: this._id(true), to: to, type: 'text', body: msg });
                return true;
            }
            
            sendRaw(payload) {
                return this._send(payload);
            }
            
            _send(p) {
                if (this.ws?.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(p));
                    return true;
                }
                return false;
            }
            
            alive() { return this.ws?.readyState === WebSocket.OPEN && this.connected; }
            canSend() { return this.alive() && !this.banned; }
            
            _id(msg = false) {
                const c = msg ? 'abcdefghijklmnopqrstuvwxyzABCDEFGHJKLMNOPQRSTUVWXYZ' : 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let s = '';
                for (let i = 0; i < 20; i++) s += c[Math.floor(Math.random() * c.length)];
                return s;
            }
        }

        // ==================== APP ====================
        const $ = id => document.getElementById(id);
        
        let clients = new Map();
        let connected = new Set();
        let inRoom = new Set();
        let banned = new Set();
        let activeRoom = '';
        let roomUsers = [];
        let targetUsers = [];
        let msgLoop = null;
        let dmLoop = null;
        let joining = false;
        let stopJoin = false;
        let stopDM = false;
        let debugMode = true;
        
        const keepAlive = new KeepAlive();

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            setupListeners();
            checkIP();
            setupTabs();
        });

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(t => {
                t.onclick = () => {
                    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
                    t.classList.add('active');
                    $(t.dataset.tab).classList.add('active');
                };
            });
        }

        function setupListeners() {
            $('btnBackground').onclick = enableBg;
            $('btnCheckIP').onclick = checkIP;
            $('chkDebugMode').onchange = () => { debugMode = $('chkDebugMode').checked; };
            
            $('btnConnect').onclick = connectIds;
            $('btnDisconnect').onclick = disconnectAll;
            
            $('btnFetchRooms').onclick = fetchRooms;
            $('btnJoinRoom').onclick = joinRoom;
            $('btnStopJoin').onclick = () => { stopJoin = true; };
            $('btnLeaveRoom').onclick = leaveRoom;
            
            $('btnStartMsgs').onclick = startMsgLoop;
            $('btnStopMsgs').onclick = stopMsgLoop;
            
            $('roomList').onchange = () => { $('inputRoom').value = $('roomList').value; };
            
            // DM
            $('btnFetchUsers').onclick = fetchUsersFromRoom;
            $('btnClearTargets').onclick = clearTargets;
            $('btnSendDM').onclick = startDMLoop;
            $('btnStopDM').onclick = () => { stopDM = true; };
            $('dmTargets').oninput = parseTargets;
            
            // Security tests
            $('btnSendRaw').onclick = sendRawPayload;
            $('btnTestRooms').onclick = testAllRoomHandlers;
            $('btnTestRoles').onclick = testRoleClaims;
            $('btnTestJoin').onclick = testJoinVariations;
            
            $('btnClearLog').onclick = () => { $('logBox').innerHTML = '<p class="info">Cleared</p>'; };
            $('btnExportLog').onclick = exportLog;
        }

        async function checkIP() {
            try {
                const r = await fetch('https://api.ipify.org?format=json');
                const d = await r.json();
                log(`Current IP: ${d.ip}`, 'info');
            } catch(e) {
                log('Could not check IP', 'warning');
            }
        }

        function enableBg() {
            if (keepAlive.start(() => {
                $('lastPing').textContent = new Date().toLocaleTimeString();
                clients.forEach(c => c.alive() && c.ws.send(''));
            })) {
                $('btnBackground').textContent = '‚úì Active';
                $('btnBackground').disabled = true;
                $('bgStatus').classList.remove('hidden');
                log('Background mode enabled', 'success');
            }
        }

        function createClient(user, pass) {
            return new Promise(resolve => {
                const url = $('serverUrl').value;
                const device = DeviceGen.gen();
                const timeout = setTimeout(() => resolve({ user, ok: false }), 20000);
                
                const cb = {
                    log: msg => log(msg),
                    raw: (u, raw) => {
                        if (debugMode) {
                            log(`[RAW ${u}] ${raw}`, 'raw');
                        }
                    },
                    login: () => {
                        clearTimeout(timeout);
                        connected.add(user);
                        updateUI();
                        updateTag(user, 'connected');
                        resolve({ user, ok: true });
                    },
                    loginFail: () => {
                        clearTimeout(timeout);
                        updateTag(user, 'failed');
                        resolve({ user, ok: false });
                    },
                    disconnect: manual => {
                        if (!manual) {
                            connected.delete(user);
                            inRoom.delete(user);
                            updateUI();
                        }
                    },
                    message: (from, msg, room, type) => {
                        addChat(from, msg, room, type);
                        const c = clients.get(user);
                        if (c && room === c.targetRoom && !c.joinConfirmed) {
                            c.joinConfirmed = true;
                            c.inRoom = true;
                            inRoom.add(user);
                            updateTag(user, 'in-room');
                            updateRoomUI();
                        }
                    },
                    rooms: rooms => updateRoomList(rooms),
                    users: users => {
                        roomUsers = users;
                        log(`Got ${users.length} room users`, 'info');
                    },
                    joined: room => {
                        inRoom.add(user);
                        updateTag(user, 'in-room');
                        updateRoomUI();
                        activeRoom = room;
                    },
                    banned: (by, reason) => {
                        banned.add(user);
                        inRoom.delete(user);
                        updateTag(user, 'banned');
                        updateRoomUI();
                    }
                };
                
                const client = new Client(user, pass, url, cb, device);
                clients.set(user, client);
            });
        }

        function updateTag(user, state) {
            const tag = $(`tag-${user}`);
            if (!tag) return;
            tag.className = 'tag';
            let icon = '‚úì';
            switch(state) {
                case 'connecting': tag.classList.add('connecting'); icon = '‚è≥'; break;
                case 'failed': tag.classList.add('failed'); icon = '‚ùå'; break;
                case 'banned': tag.classList.add('banned'); icon = 'üö´'; break;
                case 'in-room': tag.classList.add('in-room'); icon = 'üè†'; break;
            }
            tag.textContent = `${icon} ${user}`;
        }

        function updateUI() {
            $('connCount').textContent = connected.size;
            $('connIndicator').className = `indicator ${connected.size > 0 ? 'on' : 'off'}`;
            $('btnDisconnect').disabled = connected.size === 0;
            $('btnFetchRooms').disabled = connected.size === 0;
            $('btnJoinRoom').disabled = connected.size === 0;
            $('btnFetchUsers').disabled = connected.size === 0;
            $('btnSendDM').disabled = connected.size === 0;
            $('btnSendRaw').disabled = connected.size === 0;
            $('btnTestRooms').disabled = connected.size === 0;
            $('btnTestRoles').disabled = connected.size === 0;
            $('btnTestJoin').disabled = connected.size === 0;
        }

        function updateRoomUI() {
            $('inRoomCount').textContent = inRoom.size;
            $('roomIdCount').textContent = inRoom.size;
            $('btnLeaveRoom').disabled = inRoom.size === 0;
            $('btnStartMsgs').disabled = inRoom.size === 0;
            
            if (activeRoom) {
                $('currentRoom').textContent = activeRoom;
                $('roomStatus').classList.remove('hidden');
            }
        }

        async function connectIds() {
            const ids = $('inputIds').value.split('#').map(s => s.trim()).filter(s => s);
            const pass = $('inputPassword').value.trim();
            
            if (!ids.length || !pass) { log('Enter IDs and password', 'error'); return; }
            
            if (!keepAlive.active) enableBg();
            
            const delay = parseInt($('connectDelay').value) || 2000;
            
            $('btnConnect').disabled = true;
            $('idTags').innerHTML = '';
            
            ids.forEach(id => {
                const tag = document.createElement('span');
                tag.className = 'tag connecting';
                tag.id = `tag-${id}`;
                tag.textContent = `‚è≥ ${id}`;
                $('idTags').appendChild(tag);
            });
            
            log(`Connecting ${ids.length} IDs...`, 'info');
            
            for (const id of ids) {
                await createClient(id, pass);
                await sleep(delay);
            }
            
            log(`Done. Connected: ${connected.size}`, 'success');
            $('btnConnect').disabled = false;
        }

        function disconnectAll() {
            stopMsgLoop();
            stopDMLoop();
            stopJoin = true;
            
            clients.forEach(c => c.disconnect());
            clients.clear();
            connected.clear();
            inRoom.clear();
            banned.clear();
            activeRoom = '';
            
            updateUI();
            updateRoomUI();
            $('idTags').innerHTML = '';
            $('roomStatus').classList.add('hidden');
            $('joinProgress').classList.add('hidden');
            
            log('All disconnected', 'info');
        }

        function fetchRooms() {
            if (connected.size === 0) return;
            
            log('Testing all room/conference handlers...', 'info');
            
            clients.forEach(c => {
                if (c.alive()) {
                    c.fetchRooms();
                    return;
                }
            });
        }

        function updateRoomList(rooms) {
            $('roomList').innerHTML = '';
            
            if (rooms.length === 0) {
                $('roomList').innerHTML = '<option disabled>No rooms found</option>';
                return;
            }
            
            rooms.forEach(r => {
                const name = typeof r === 'string' ? r : (r.name || r.room || r.conference || r.jid || '');
                if (name) {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    $('roomList').appendChild(opt);
                }
            });
            
            log(`Listed ${rooms.length} rooms`, 'success');
        }

        async function joinRoom() {
            const room = $('inputRoom').value.trim();
            if (!room) { log('Enter room name', 'error'); return; }
            if (connected.size === 0) { log('No IDs connected', 'error'); return; }
            if (joining) return;
            
            joining = true;
            stopJoin = false;
            
            const claimRole = $('claimRole').value;
            const delay = parseInt($('joinDelay').value) || 5000;
            
            $('btnJoinRoom').disabled = true;
            $('btnStopJoin').classList.remove('hidden');
            
            activeRoom = room;
            $('currentRoom').textContent = room;
            $('roomStatus').classList.remove('hidden');
            
            $('joinProgress').classList.remove('hidden');
            $('joinProgress').innerHTML = '';
            
            log(`Joining ${room}${claimRole ? ` with role claim: ${claimRole}` : ''}...`, 'info');
            
            const arr = Array.from(clients.entries());
            
            for (let i = 0; i < arr.length; i++) {
                if (stopJoin) break;
                
                const [user, client] = arr[i];
                
                addProgress(user, '‚è≥', 'Joining...');
                
                if (!client.alive()) {
                    updateProgress(user, '‚ùå', 'Offline');
                    continue;
                }
                
                if (client.banned && $('chkAutoDevice').checked) {
                    const newDev = client.newDevice();
                    log(`[${user}] New device: ${newDev.id}`, 'warning');
                }
                
                client.join(room, claimRole);
                
                const result = await waitJoin(user, 8000);
                
                if (result.ok) {
                    updateProgress(user, '‚úì', 'In Room');
                    inRoom.add(user);
                } else if (result.banned) {
                    updateProgress(user, 'üö´', 'Banned');
                } else {
                    // Assume success on timeout (server might not send confirmation)
                    client.inRoom = true;
                    client.joinConfirmed = true;
                    inRoom.add(user);
                    updateProgress(user, '‚úì', 'In Room (assumed)');
                }
                
                updateRoomUI();
                
                if (i < arr.length - 1 && !stopJoin) {
                    await sleep(delay);
                }
            }
            
            joining = false;
            $('btnJoinRoom').disabled = false;
            $('btnStopJoin').classList.add('hidden');
            
            log(`Join complete. ${inRoom.size} IDs in room`, 'success');
        }

        function addProgress(user, icon, status) {
            const p = document.createElement('p');
            p.id = `prog-${user}`;
            p.className = 'info';
            p.textContent = `${icon} ${user}: ${status}`;
            $('joinProgress').appendChild(p);
        }

        function updateProgress(user, icon, status) {
            const p = $(`prog-${user}`);
            if (p) {
                p.textContent = `${icon} ${user}: ${status}`;
                p.className = icon === '‚úì' ? 'success' : (icon === 'üö´' ? 'ban' : 'warning');
            }
        }

        function waitJoin(user, timeout) {
            return new Promise(resolve => {
                const client = clients.get(user);
                if (!client) { resolve({ ok: false }); return; }
                
                const start = Date.now();
                const check = setInterval(() => {
                    if (client.joinConfirmed || client.inRoom) {
                        clearInterval(check);
                        resolve({ ok: true });
                    } else if (client.banned) {
                        clearInterval(check);
                        resolve({ ok: false, banned: true });
                    } else if (Date.now() - start > timeout) {
                        clearInterval(check);
                        resolve({ ok: false });
                    }
                }, 300);
            });
        }

        function leaveRoom() {
            if (!activeRoom) return;
            stopMsgLoop();
            
            clients.forEach(c => c.alive() && c.leave(activeRoom));
            inRoom.clear();
            updateRoomUI();
            
            $('roomStatus').classList.add('hidden');
            $('joinProgress').classList.add('hidden');
            
            log(`Left room: ${activeRoom}`, 'info');
            activeRoom = '';
        }

        // ========== ROOM MESSAGES ==========
        function startMsgLoop() {
            const msgs = $('roomMsgs').value.split('\n').filter(m => m.trim());
            if (!msgs.length) { log('Enter messages', 'error'); return; }
            if (!activeRoom) { log('Join a room first', 'error'); return; }
            
            const interval = Math.max(500, parseInt($('msgInterval').value) || 3000);
            let idx = 0;
            let count = 0;
            
            const send = () => {
                const msg = msgs[idx % msgs.length];
                let sent = 0;
                
                clients.forEach(c => {
                    if (c.canSend() && (c.inRoom || c.joinConfirmed || inRoom.has(c.user))) {
                        c.sendRoom(activeRoom, msg);
                        sent++;
                    }
                });
                
                if (sent > 0) {
                    count++;
                    $('msgSentCount').textContent = count;
                }
                idx++;
            };
            
            send();
            msgLoop = setInterval(send, interval);
            
            $('btnStartMsgs').disabled = true;
            $('btnStopMsgs').disabled = false;
            $('msgStatus').classList.remove('hidden');
            $('msgLoopStatus').textContent = 'Sending...';
            $('msgLoopStatus').classList.add('sending');
            
            log(`Started: ${msgs.length} messages, ${interval}ms`, 'success');
        }

        function stopMsgLoop() {
            if (msgLoop) clearInterval(msgLoop);
            msgLoop = null;
            
            $('btnStartMsgs').disabled = false;
            $('btnStopMsgs').disabled = true;
            $('msgLoopStatus').textContent = 'Stopped';
            $('msgLoopStatus').classList.remove('sending');
        }

        // ========== DM ==========
        function parseTargets() {
            const text = $('dmTargets').value.trim();
            targetUsers = text.split(/[#\n]/).map(s => s.trim()).filter(s => s);
            targetUsers = [...new Set(targetUsers)];
            updateTargetList();
        }

        function fetchUsersFromRoom() {
            if (roomUsers.length > 0) {
                const others = roomUsers.map(u => u.username || u).filter(u => !connected.has(u));
                targetUsers = [...new Set([...targetUsers, ...others])];
                $('dmTargets').value = targetUsers.join('\n');
                updateTargetList();
                log(`Added ${others.length} users from room`, 'success');
            } else {
                clients.forEach(c => c.alive() && c.fetchUsers());
                log('Fetching users...', 'info');
            }
        }

        function clearTargets() {
            targetUsers = [];
            $('dmTargets').value = '';
            updateTargetList();
        }

        function updateTargetList() {
            $('targetCount').textContent = targetUsers.length;
            
            if (!targetUsers.length) {
                $('targetList').innerHTML = '<p style="color:#555;text-align:center;font-size:0.8rem">No users</p>';
                return;
            }
            
            $('targetList').innerHTML = targetUsers.map(u => `<div class="user-item"><span>${u}</span></div>`).join('');
        }

        async function startDMLoop() {
            if (!targetUsers.length) { log('Add target users', 'error'); return; }
            
            const msg = $('dmMessage').value.trim();
            if (!msg) { log('Enter a message', 'error'); return; }
            if (connected.size === 0) { log('Connect IDs first', 'error'); return; }
            
            stopDM = false;
            const delay = parseInt($('dmDelay').value) || 2000;
            let count = 0;
            
            $('btnSendDM').disabled = true;
            $('btnStopDM').classList.remove('hidden');
            $('dmStatus').classList.remove('hidden');
            $('dmLoopStatus').textContent = 'Sending...';
            $('dmLoopStatus').classList.add('sending');
            
            // Get first available client
            let sender = null;
            clients.forEach(c => { if (c.alive() && !sender) sender = c; });
            
            if (!sender) { log('No client available', 'error'); stopDMLoop(); return; }
            
            log(`Sending DM to ${targetUsers.length} users...`, 'info');
            
            for (const target of targetUsers) {
                if (stopDM) break;
                
                sender.sendDM(target, msg);
                count++;
                $('dmSentCount').textContent = count;
                log(`üì® DM to ${target}`, 'dm');
                
                await sleep(delay);
            }
            
            log(`DM complete. Sent: ${count}`, 'success');
            stopDMLoop();
        }

        function stopDMLoop() {
            stopDM = true;
            $('btnSendDM').disabled = false;
            $('btnStopDM').classList.add('hidden');
            $('dmLoopStatus').textContent = 'Stopped';
            $('dmLoopStatus').classList.remove('sending');
        }

        // ========== SECURITY TESTS ==========
        function sendRawPayload() {
            try {
                const payload = JSON.parse($('customPayload').value);
                let sent = 0;
                
                clients.forEach(c => {
                    if (c.alive()) {
                        c.sendRaw(payload);
                        sent++;
                    }
                });
                
                log(`Sent raw payload to ${sent} clients`, 'success');
            } catch(e) {
                log('Invalid JSON: ' + e.message, 'error');
            }
        }

        function testAllRoomHandlers() {
            log('=== Testing all room list handlers ===', 'warning');
            fetchRooms();
        }

        function testRoleClaims() {
            const room = $('inputRoom').value.trim() || 'test';
            const roles = ['member', 'moderator', 'admin', 'owner', 'super', 'vip', 'staff'];
            
            log('=== Testing role claims ===', 'warning');
            log('If any role bypasses validation, server has vulnerability', 'info');
            
            let client = null;
            clients.forEach(c => { if (c.alive() && !client) client = c; });
            
            if (!client) { log('No client available', 'error'); return; }
            
            roles.forEach((role, i) => {
                setTimeout(() => {
                    log(`Testing role claim: ${role}`, 'info');
                    
                    // Try various payload formats
                    const payloads = [
                        { handler: 'room_join', id: client._id(), name: room, role: role },
                        { handler: 'room_join', id: client._id(), name: room, user_role: role },
                        { handler: 'room_join', id: client._id(), name: room, member_role: role },
                        { handler: 'room_join', id: client._id(), name: room, affiliation: role },
                        { handler: 'room_join', id: client._id(), name: room, level: role },
                        { handler: 'join_room', id: client._id(), room: room, role: role }
                    ];
                    
                    payloads.forEach((p, j) => {
                        setTimeout(() => client.sendRaw(p), j * 100);
                    });
                }, i * 1500);
            });
        }

        function testJoinVariations() {
            const room = $('inputRoom').value.trim() || 'test';
            
            log('=== Testing join handler variations ===', 'warning');
            
            let client = null;
            clients.forEach(c => { if (c.alive() && !client) client = c; });
            
            if (!client) { log('No client available', 'error'); return; }
            
            const handlers = [
                'room_join', 'join_room', 'conference_join', 'join_conference',
                'group_join', 'join_group', 'enter_room', 'enter', 'join',
                'room_enter', 'chat_join', 'channel_join'
            ];
            
            handlers.forEach((h, i) => {
                setTimeout(() => {
                    log(`Testing: ${h}`, 'info');
                    client.sendRaw({ handler: h, id: client._id(), name: room, room: room });
                }, i * 500);
            });
        }

        // ========== CHAT & LOG ==========
        function addChat(from, msg, room, type) {
            const box = $('chatBox');
            if (box.querySelector('p[style]')) box.innerHTML = '';
            
            const isOwn = connected.has(from);
            const isDM = type === 'dm';
            
            const div = document.createElement('div');
            div.className = `chat-msg ${isOwn ? 'own' : ''} ${isDM ? 'dm' : ''}`;
            div.innerHTML = `
                <div class="from">${from}${isDM ? ' (DM)' : room ? ` in ${room}` : ''}</div>
                <div class="text">${escapeHtml(msg)}</div>
                <div class="time">${new Date().toLocaleTimeString()}</div>
            `;
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            
            while (box.children.length > 100) box.removeChild(box.firstChild);
        }

        function log(msg, type = 'info') {
            const p = document.createElement('p');
            p.className = type;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            $('logBox').appendChild(p);
            $('logBox').scrollTop = $('logBox').scrollHeight;
            
            while ($('logBox').children.length > 500) $('logBox').removeChild($('logBox').firstChild);
        }

        function exportLog() {
            const logs = [];
            $('logBox').querySelectorAll('p').forEach(p => logs.push(p.textContent));
            const blob = new Blob([logs.join('\n')], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `security-test-${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
        }

        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</body>
</html>